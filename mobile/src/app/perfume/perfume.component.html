<GridLayout rows="auto, *, auto" class="ns-dark bg-dark h-full">

  <StackLayout row="0" height="24"></StackLayout>

  <ScrollView row="1">
    <StackLayout class="px-6 pb-10">

      <StackLayout *ngIf="loading"
                   class="items-center mt-20">
        <ActivityIndicator busy="true"
                           color="#D3A54A" />
      </StackLayout>

      <ng-container *ngIf="!loading && details">

        <StackLayout class="pt-4 mb-4">
          <Label
            [text]="details.name"
            textWrap="true"
            class="text-2xl font-semibold text-text-primary mb-1"></Label>

          <Label
            [text]="details.brand"
            class="text-sm text-text-secondary"></Label>
        </StackLayout>

        <GridLayout
          class="rounded-3xl bg-dark-secondary h-56 mb-6 overflow-hidden">

          <Image
            [src]="perfumeImageSrc"
            stretch="aspectFill"
            opacity="0.35"
            blurRadius="25"
            borderRadius="24">
          </Image>

          <Image
            [src]="perfumeImageSrc"
            stretch="aspectFit"
            loadMode="async"
            class="rounded-lg"
            (loaded)="onImageLoaded($event)">
          </Image>

        </GridLayout>

        <StackLayout orientation="horizontal" class="mb-6 items-center">
          <Label
            text="★"
            class="text-brand-gold text-sm mr-1"></Label>

          <Label
            [text]="details.avgRating.toFixed(1)"
            class="text-text-secondary text-sm"></Label>

          <Label
            text=" · "
            class="text-text-secondary text-sm"></Label>

          <Label
            [text]="details.ratingCount + ' votes'"
            class="text-text-secondary text-sm"></Label>

          <ng-container *ngIf="details.commentCount > 0">
            <Label
              text=" · "
              class="text-text-secondary text-sm"></Label>

            <Label
              text="&#xf075;"
              class="fas text-text-secondary text-sm mr-1"></Label>

            <Label
              [text]="details.commentCount"
              class="text-text-secondary text-sm"></Label>
          </ng-container>
        </StackLayout>

        <StackLayout class="mb-4">
          <FlexboxLayout flexWrap="wrap">
            <StackLayout *ngFor="let g of details.groups"
                        class="rounded-xl px-3 py-2 mr-2 mb-2"
                        [style.borderWidth]="1"
                        [style.borderColor]="getGroupColor(g)"
                        [style.backgroundColor]="'transparent'">
              <Label
                [text]="g"
                class="text-xs"
                [style.color]="getGroupColor(g)"></Label>
            </StackLayout>
          </FlexboxLayout>
        </StackLayout>

        <StackLayout class="mb-6">

          <StackLayout *ngFor="let group of details.noteGroups"
                       class="mb-3">

            <Label
              [text]="noteTypeLabel(group.type)"
              class="text-xs text-text-secondary mb-2"></Label>

            <FlexboxLayout flexWrap="wrap">
              <StackLayout *ngFor="let n of group.notes"
                           class="bg-dark-secondary rounded-xl px-3 py-2 mr-2 mb-2">
                <Label
                  [text]="n.name"
                  class="text-xs text-text-primary"></Label>
              </StackLayout>
            </FlexboxLayout>

          </StackLayout>

        </StackLayout>

        <StackLayout class="mb-6 bg-dark-secondary rounded-2xl p-4">

          <Label
            text="Your Rating"
            class="text-sm font-semibold text-text-primary mb-1">
          </Label>

          <StackLayout orientation="horizontal" class="mb-4">
            <Label
              *ngFor="let star of [1,2,3,4,5]; let i = index"
              [text]="star <= (userRating || 0) ? '★' : '☆'"
              class="text-3xl mr-1"
              [class.text-brand-gold]="star <= (userRating || 0)"
              [class.text-text-secondary]="!(star <= (userRating || 0))"
              [class.opacity-100]="star <= (userRating || 0)"
              [class.opacity-50]="!(star <= (userRating || 0))"
              (tap)="rate(star)">
            </Label>
          </StackLayout>

          <GridLayout rows="*, auto" class="mb-1">
            
            <TextView
              row="0"
              [(ngModel)]="reviewText"
              (ngModelChange)="isDirty = true"
              hint="Write a review (optional) ..."
              returnKeyType="done"
              rows="4"
              maxLength="2000"
              autocorrect="true"
              class="bg-dark rounded-xl text-text-primary text-sm"
              style="padding: 16; padding-right: 56; border-width: 1; border-color: #333333; min-height: 120; placeholder-color: #B8B8B8; line-height: 8;">
            </TextView>
            
            <GridLayout
              row="0"
              rowSpan="2"
              horizontalAlignment="right"
              verticalAlignment="bottom"
              marginRight="8"
              marginBottom="8"
              width="44"
              height="44"
              [class.opacity-50]="!(isDirty && userRating && !isSubmitting)"
              [isUserInteractionEnabled]="isDirty && !!userRating && !isSubmitting"
              (tap)="submitReview()"
              class="rounded-full bg-brand-gold">
              
              <StackLayout verticalAlignment="center" horizontalAlignment="center">
                  <Label
                      *ngIf="!isSubmitting"
                      text="&#xf0c7;"
                      class="fas text-black text-lg">
                  </Label>
                  
                  <ActivityIndicator
                      *ngIf="isSubmitting"
                      busy="true"
                      color="#000000"
                      width="20"
                      height="20"
                      verticalAlignment="center"
                      horizontalAlignment="center">
                  </ActivityIndicator>
              </StackLayout>
            </GridLayout>
            
            <Label row="1"
                   *ngIf="reviewText"
                   [text]="reviewText.length + '/2000'"
                   class="text-right text-2xs text-text-secondary mt-1">
            </Label>
            
          </GridLayout>

        </StackLayout>

        <StackLayout>

          <Label
            text="Reviews"
            class="text-lg font-semibold text-text-primary mb-4">
          </Label>

          <StackLayout *ngFor="let r of details.reviews"
                       class="mb-4 bg-dark-secondary rounded-2xl px-4 py-3">

            <GridLayout columns="*, auto"
                        class="mb-1">
              <Label
                [text]="r.author"
                class="text-xs text-text-primary font-semibold">
              </Label>

              <StackLayout col="1" orientation="horizontal">
                <Label
                  text="★ "
                  class="text-xs text-brand-gold">
                </Label>
                <Label
                  [text]="r.rating"
                  class="text-xs text-brand-gold">
                </Label>
              </StackLayout>
            </GridLayout>

            <Label
              *ngIf="r.text"
              [text]="r.text"
              textWrap="true"
              class="text-xs text-text-secondary mt-2">
            </Label>

            <Label
              [text]="r.createdAt | date:'mediumDate'"
              class="text-2xs text-text-secondary mt-2">
            </Label>

          </StackLayout>

          <StackLayout class="items-center mt-2">
            <Label
              text="See all reviews"
              class="text-xs text-brand-gold underline"
              opacity="0.7">
            </Label>
          </StackLayout>

        </StackLayout>

      </ng-container>

    </StackLayout>
  </ScrollView>

  <app-footer row="2"></app-footer>

</GridLayout>
