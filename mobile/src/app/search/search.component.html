<GridLayout rows="auto, *, auto"
            class="ns-dark bg-dark">

  <StackLayout row="0"
               class="px-6 pt-10 pb-3 bg-dark">
    <Label text="Search perfumes"
           class="text-2xl font-semibold text-text-primary mb-1"></Label>

    <Label [text]="filtersSummary"
           class="text-xs text-text-secondary mb-3"></Label>

    <GridLayout columns="*, auto"
                rows="auto"
                class="items-center">
      <TextField
        col="0"
        verticalAlignment="stretch"
        [formControl]="searchControl"
        class="bg-dark-secondary text-text-primary rounded-2xl px-4 mr-2"
        hint="Find your perfume here..." />

      <GridLayout
        col="1"
        rows="auto"
        class="bg-dark-secondary rounded-2xl px-4 py-4"
        horizontalAlignment="center"
        verticalAlignment="center"
        (tap)="openFilters()">

        <Label
          *ngIf="filtersReady"
          text="&#xf0b0;"
          class="fas text-text-primary text-lg"
          horizontalAlignment="center"
          verticalAlignment="center">
        </Label>

        <ActivityIndicator
          *ngIf="!filtersReady"
          busy="true"
          width="20"
          height="20"
          color="#D3A54A"
          horizontalAlignment="center"
          verticalAlignment="center">
        </ActivityIndicator>

      </GridLayout>
    </GridLayout>
  </StackLayout>

  <StackLayout row="1" class="px-6 pb-6">
    <Label *ngIf="!loading && !results.length"
           text="No perfumes found."
           class="mt-6 text-sm text-text-secondary"></Label>
    <Label
      *ngIf="!loading && results.length"
      [text]="'Found ' + totalCount + ' perfumes matching the criteria.'"
      class="mt-4 text-xs text-text-secondary"
    ></Label>
    <Label 
      *ngIf="errorMessage"
      [text]="errorMessage"
      class="mt-3 text-xs text-red-500"
    ></Label>

    <ListView
      [items]="results"
      [itemTemplateSelector]="selectTemplate"
      (loadMoreItems)="onLoadMore()"
      class="mt-2"
      (itemTap)="onPerfumeTap($event)">

      <ng-template nsTemplateKey="item" let-row="item">
        <StackLayout>

          <GridLayout
            columns="*,auto"
            class="bg-dark-secondary rounded-2xl px-4 py-3">

            <StackLayout col="0">
              <Label
                [text]="row.data.name"
                textWrap="true"
                maxLines="2"
                verticalAlignment="top"
                class="text-text-primary font-semibold"
                android:lineSpacingMultiplier="1"
                android:lineSpacingExtra="0">
              </Label>

              <Label [text]="row.data.brand"
                    class="text-text-secondary text-xs mt-0.5"></Label>

              <GridLayout columns="auto, auto"
                          class="items-center mt-1">
                <Label text="★"
                      col="0"
                      class="text-brand-gold text-xs mr-1"></Label>

                <Label [text]="formatRating(row.data)"
                      col="1"
                      class="text-text-secondary text-xs"></Label>
              </GridLayout>
            </StackLayout>

            <StackLayout
              col="1"
              width="56"
              height="56"
              class="mr-3 rounded-2xl bg-dark border border-dark-secondary" />

          </GridLayout>

          <StackLayout height="12"></StackLayout>

        </StackLayout>
      </ng-template>

      <ng-template nsTemplateKey="spinner">
        <StackLayout class="py-6 items-center">
          <ActivityIndicator busy="true"
                            color="#D3A54A" />
        </StackLayout>
      </ng-template>
    </ListView>

    <ActivityIndicator
      *ngIf="loading"
      busy="true"
      class="mt-4"
      color="#D3A54A"
      horizontalAlignment="center"
    ></ActivityIndicator>

  </StackLayout>
  <app-footer row="2"></app-footer>
  <GridLayout 
    [visibility]="showFilters ? 'visible' : 'collapsed'"
    rows="*, auto"
    rowSpan="3">

    <StackLayout
      id="backdrop"
      row="0"
      class="bg-black"
      (tap)="closeFilters()">
    </StackLayout>

    <GridLayout
      id="filterSheet"
      row="1"
      rows="auto, *, auto"
      class="bg-dark-secondary rounded-t-3xl px-6 pt-4 pb-6"
      height="90%"
      (loaded)="onFilterSheetLoaded($event)"
      (pan)="onSheetPan($event)">
        <StackLayout
          row="0"
          width="40"
          height="4"
          class="bg-dark border border-dark-secondary rounded-full">
        </StackLayout>   
        <StackLayout row="1">
            <Label text="Filters"
                   class="text-lg font-semibold text-text-primary mb-4"></Label>

            <StackLayout class="mb-4">
                <Label text="Brand"
                       class="text-xs text-text-secondary mb-1"></Label>

                <TextField [(ngModel)]="brandSearchText"
                           class="bg-dark text-text-primary rounded-2xl px-4 py-2 mb-2"
                           hint="Search brands..." />

                <ScrollView height="120" class="bg-dark rounded-2xl">
                    <StackLayout>
                        <StackLayout class="px-4 py-2"
                                     (tap)="selectBrand(null)">
                            <Label text="Any brand"
                                   [class.text-highlight]="selectedBrandId === null"
                                   class="text-xs text-text-primary"></Label>
                        </StackLayout>

                        <StackLayout *ngFor="let b of filteredBrands"
                                     class="px-4 py-2 border-t border-dark-secondary"
                                     (tap)="selectBrand(b)">
                            <GridLayout columns="*, auto">
                                <Label [text]="b.name"
                                       class="text-xs text-text-primary"></Label>

                                <Label *ngIf="isBrandSelected(b)"
                                       text="●"
                                       col="1"
                                       class="text-brand-gold text-xs"></Label>
                            </GridLayout>
                        </StackLayout>
                    </StackLayout>
                </ScrollView>
            </StackLayout>

            <StackLayout class="mb-4">
                <Label text="Groups"
                       class="text-xs text-text-secondary mb-1"></Label>

                <TextField [(ngModel)]="groupSearchText"
                           class="bg-dark text-text-primary rounded-2xl px-4 py-2 mb-2"
                           hint="Search groups..." />

                <ScrollView height="140" class="bg-dark rounded-2xl">
                    <StackLayout>
                        <StackLayout *ngFor="let g of filteredGroups"
                                     class="px-4 py-2 border-t border-dark-secondary"
                                     (tap)="toggleGroup(g)">
                            <GridLayout columns="*, auto">
                                <Label [text]="g.name"
                                       class="text-xs text-text-primary"></Label>

                                <Label *ngIf="isGroupSelected(g)"
                                       text="✓"
                                       col="1"
                                       class="text-brand-gold text-xs"></Label>
                            </GridLayout>
                        </StackLayout>
                    </StackLayout>
                </ScrollView>
            </StackLayout>

            <StackLayout class="mb-4">
              <Label text="Gender"
                    class="text-xs text-text-secondary mb-2"></Label>

              <FlexboxLayout justifyContent="space-between">
                <Label text="Any"
                      class="filter-chip"
                      [class.selected]="selectedGender === null"
                      (tap)="selectGender(null)"></Label>

                <Label text="Male"
                      class="filter-chip"
                      [class.selected]="selectedGender === GenderEnum.Male"
                      (tap)="selectGender(GenderEnum.Male)"></Label>

                <Label text="Female"
                      class="filter-chip"
                      [class.selected]="selectedGender === GenderEnum.Female"
                      (tap)="selectGender(GenderEnum.Female)"></Label>

                <Label text="Unisex"
                      class="filter-chip"
                      [class.selected]="selectedGender === GenderEnum.Unisex"
                      (tap)="selectGender(GenderEnum.Unisex)"></Label>
              </FlexboxLayout>
            </StackLayout>

            <StackLayout class="mb-4">
              <Label text="Minimum rating"
                    class="text-xs text-text-secondary mb-2"></Label>

              <FlexboxLayout justifyContent="space-between">
                <Label text="Any"
                      class="filter-chip"
                      [class.selected]="selectedMinRating === null"
                      (tap)="setMinRating(null)"></Label>

                <Label text="4+"
                      class="filter-chip"
                      [class.selected]="selectedMinRating === 4"
                      (tap)="setMinRating(4)"></Label>

                <Label text="3+"
                      class="filter-chip"
                      [class.selected]="selectedMinRating === 3"
                      (tap)="setMinRating(3)"></Label>

                <Label text="2+"
                      class="filter-chip"
                      [class.selected]="selectedMinRating === 2"
                      (tap)="setMinRating(2)"></Label>
              </FlexboxLayout>
            </StackLayout>
        </StackLayout>

        <FlexboxLayout row="2"
                       justifyContent="space-between" 
                       class="mt-4">
            <StackLayout class="bg-dark rounded-2xl px-4 py-3 w-48 mr-2 items-center justify-center"
                         (tap)="clearFilters()">
                <Label text="Clear"
                       class="text-sm text-text-secondary text-center"></Label>
            </StackLayout>
            
            <StackLayout class="bg-brand-gold rounded-2xl px-4 py-3 ml-2 w-48 items-center justify-center"
                         (tap)="applyFilters()">
                <Label text="Apply"
                       class="text-sm text-dark font-semibold text-center"></Label>
            </StackLayout>
        </FlexboxLayout>
    </GridLayout>
  </GridLayout>
</GridLayout>
